$(function(){var t,e,T=$("#tb_fullname"),H=$("#tb_username"),x=$("#tb_password"),j=$("#tb_repassword"),P=$("#ddl_province"),S=$("#ddl_district"),I=$("#ddl_school"),M=$("#ddl_class"),N=$("#tb_class_name"),O=$("#tb_birthday"),n=$("#img_captcha"),q=$("#tb_captcha"),C=$("#lb_message_register"),U=$("#bt_save");function V(){return n.attr("src","/captcha.png?tn="+Math.random()),q.val(""),!1}T.focus(),O.datepicker({dateFormat:"dd/mm/yy"}),n.click(function(){return V()}),P.change(function(){var n=parseInt($(this).val());t&&clearTimeout(t),t=setTimeout(function(){S.prop("disabled",!0).html('<option value="0">Chọn quận/huyện</option>'),I.prop("disabled",!0).html('<option value="0">Chọn trường</option>'),0<n&&$.ajax({url:"/district/api/list/"+n,dataType:"json",beforeSend:function(n){spinner.show()},success:function(n){if(0===n.error){if(n.content){var e="";$.each(n.content,function(n,t){e+='<option value="'+t._id+'">'+t.name+"</option>"}),S.append(e),S.prop("disabled",!1)}}else ShowMessError(n.message)}})},1e3)}),S.change(function(){var n=parseInt($(this).val());e&&clearTimeout(e),e=setTimeout(function(){I.attr("disabled","disabled").html('<option value="0">Chọn trường</option>'),0<n&&$.ajax({url:"/school/api/list/"+n,dataType:"json",beforeSend:function(n){spinner.show()},success:function(n){if(0==n.error){if(n.content){var e="";$.each(n.content,function(n,t){e+='<option value="'+t._id+'">'+t.name+"</option>"}),I.append(e),I.prop("disabled",!1)}}else ShowMessError(n.message)}})},1e3)}),U.click(function(){var n=T.val(),t=H.val(),e=x.val(),i=j.val(),a=P.val(),o=S.val(),r=I.val(),s=M.val(),c=N.val(),h=O.val(),l=q.val();if(!$("#cb_accept").prop("checked"))return C.show().text("Vui lòng kiểm tra lại điều khoản"),!1;var p,d,u,g,b,v,f,m,w,y,k,_=(d=t,u=e,g=i,b=a,v=o,f=r,m=s,w=h,y=l,(k="")==(p=n)?k="Hãy nhập họ tên":p.length<3&&30<p.length?(""!=k&&(k+="<br/>"),k+="Họ tên không đúng, phải dài từ 3 đến 30 ký tự"):util.isNameVi(p)||(""!=k&&(k+="<br/>"),k+="Họ tên không đúng, không có ký tự đặc biệt và số"),""==d?(""!=k&&(k+="<br/>"),k+="Hãy nhập tên đăng nhập"):d.length<6||20<d.length?(""!=k&&(k+="<br/>"),k+="Tên đăng nhập phải &ge; 6 và &le; 20 ký tự và bắt đầu là chữ"):util.isUsername(d)||(""!=k&&(k+="<br/>"),k+="Tên đăng nhập không được chứa ký tự đặc biệt"),""==u?(""!=k&&(k+="<br/>"),k+="Hãy nhập mật khẩu"):(u.length<6||30<u.length)&&(""!=k&&(k+="<br/>"),k+="Mật khẩu phải từ 6 đến 30 ký tự"),""==g?(""!=k&&(k+="<br/>"),k+="Hãy nhập lại mật khẩu"):g!=u&&(""!=k&&(k+="<br/>"),k+="Mật khẩu không trùng khớp"),parseInt(b)<=0&&(""!=k&&(k+="<br/>"),k+="Hãy chọn tỉnh/thành phố"),parseInt(v)<=0&&(""!=k&&(k+="<br/>"),k+="Hãy chọn quận/huyện"),parseInt(f)<=0&&(""!=k&&(k+="<br/>"),k+="Hãy chọn trường"),((m=parseInt(m))<=0||5<m)&&(""!=k&&(k+="<br/>"),k+="Hãy chọn lớp/khối"),""==w?(""!=k&&(k+="<br/>"),k+="Hãy chọn ngày sinh"):util.isValidDate(w)||(""!=k&&(k+="<br/>"),k+="Định dạng ngày tháng không đúng"),""==y?(""!=k&&(k+="<br/>"),k+="Hãy nhập mã xác nhận"):6!=y.length&&(""!=k&&(k+="<br/>"),k+="Mã xác nhận phải có 6 ký tự"),k);return""!==_?C.html(_):$.ajax({url:"/user/register",type:"POST",dataType:"json",data:{fullname:n,username:t,password:e,repassword:i,province_id:a,district_id:o,school_id:r,class_id:s,class_name:c,birthday:h,captcha:l,position:"object"==typeof window.position?JSON.stringify({accuracy:window.position.accuracy,latitude:window.position.latitude,longitude:window.position.longitude,speed:window.position.speed}):window.position},beforeSend:function(n){C.show().text("Đăng thực hiện..."),spinner.show(),U.prop("disabled",!0)},success:function(n){if(0==n.error){var t=[{caption:"Trang chủ",callback:function(){window.location.href="/"}}];TN_POPUP.show("Tạo tài khoản thành công<br/>Hãy quay về trang chủ để đăng nhập và tiếp tục",null,470,215,t,null,!1)}else TN_POPUP.show(n.message),C.show().text(n.message)}}).always(function(){V(),spinner.hide(),U.prop("disabled",!1)}),!1})});